version: '3.8'

services:
  fleet-server:
    image: docker.elastic.co/elastic-agent/elastic-agent:${ELASTIC_VERSION:-9.2.3}
    container_name: elastic-fleet-server
    restart: unless-stopped
    hostname: fleet-server
    environment:
      - FLEET_SERVER_ENABLE=true
      - FLEET_SERVER_ELASTICSEARCH_HOST=https://elasticsearch:9200
      - FLEET_SERVER_ELASTICSEARCH_USERNAME=${ELASTIC_USERNAME}
      - FLEET_SERVER_ELASTICSEARCH_PASSWORD=${ELASTIC_PASSWORD}
      - FLEET_SERVER_ELASTICSEARCH_CA=/certs/ca.crt
      - FLEET_SERVER_SERVICE_TOKEN=${FLEET_SERVER_SERVICE_TOKEN}
      - FLEET_SERVER_POLICY_ID=fleet-server-policy
      - FLEET_SERVER_HOST=0.0.0.0
      - FLEET_SERVER_PORT=8220
      - FLEET_SERVER_INSECURE_HTTP=false
      - FLEET_SERVER_CERT=/certs/fleet-server/fleet-server.crt
      - FLEET_SERVER_CERT_KEY=/certs/fleet-server/fleet-server.key
      - FLEET_SERVER_CLIENT_CA=/certs/ca.crt
      - CERTIFICATE_AUTHORITIES=/certs/ca.crt
    ports:
      - "8220:8220"
    volumes:
      - ./secrets/certs:/certs:ro
    networks:
      - elastic
    depends_on:
      elasticsearch:
        condition: service_healthy
      kibana:
        condition: service_healthy

networks:
  elastic:
    external: true
